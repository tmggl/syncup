<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Add New Project</title>
        <style>
            /* âœ… Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
            * {
                box-sizing: border-box;
                font-family: 'Segoe UI', sans-serif;
                margin: 0;
                padding: 0;
            }
    
            body {
                background: #f8f9fa;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 15px;
            }
    
            /* âœ… ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
            .modal {
                background: white;
                width: 100%;
                max-width: 400px;  /* â¬…ï¸ ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ */
                padding: 15px;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
                border-radius: 12px;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù */
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
                margin-top: 50px;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
            }
    
            h2 {
                text-align: center;
                color: #2c3e50;
                font-size: 1.3rem;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
                margin-bottom: 1rem;
                font-weight: 600;
            }
    
            /* âœ… ØªØµØºÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ù…ÙŠØ§Øª */
            .form-group {
                margin-bottom: 1rem;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ */
            }
    
            label {
                display: block;
                font-size: 0.8rem;  /* â¬…ï¸ ØªØµØºÙŠØ± Ø§Ù„Ù†ØµÙˆØµ */
                color: #4a5568;
                margin-bottom: 0.3rem;
                font-weight: 500;
            }
    
            input, 
            select, 
            textarea {
                width: 100%;
                padding: 0.6rem;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
                font-size: 0.8rem;  /* â¬…ï¸ ØªØµØºÙŠØ± Ø§Ù„Ù†Øµ */
                border-radius: 6px;
                border: 1px solid #e2e8f0;
                background: #f8fafc;
            }
    
            input:focus, 
            select:focus, 
            textarea:focus {
                border-color: #6a0dad;
                box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.15);
                outline: none;
            }
    
            textarea {
                min-height: 80px;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
                resize: vertical;
            }
    
            /* âœ… ØªØµÙ…ÙŠÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª */
            .file-upload {
                border: 2px dashed #cbd5e0;
                border-radius: 6px;
                padding: 1rem;
                text-align: center;
                cursor: pointer;
                transition: 0.3s;
                background: #f8fafc;
            }
    
            .file-upload:hover {
                border-color: #6a0dad;
                background: rgba(106, 13, 173, 0.05);
            }
    
            .file-preview {
                margin-top: 0.5rem;
                font-size: 0.75rem;
                color: #4a5568;
            }
    
            /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® */
            .date-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.8rem;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® */
                margin-bottom: 1rem;
            }
    
            /* âœ… ØªØµØºÙŠØ± Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ */
            .color-select {
                width: 100%;
                padding: 0.5rem;
                border-radius: 6px;
                font-size: 0.8rem;
            }
    
            /* âœ… ØªØµØºÙŠØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
            .buttons {
                display: flex;
                gap: 0.8rem;
                margin-top: 1rem;
            }
    
            .btn {
                flex: 1;
                padding: 0.6rem 1rem;  /* â¬…ï¸ ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
                font-size: 0.8rem;  /* â¬…ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
                border-radius: 6px;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.3s;
            }
    
            .cancel {
                background: #f1f5f9;
                color: #64748b;
            }
    
            .cancel:hover {
                background: #e2e8f0;
            }
    
            .add {
                background: linear-gradient(135deg, #6a0dad, #4b0082);
                color: white;
                box-shadow: 0 4px 6px rgba(106, 13, 173, 0.2);
            }
    
            .add:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 12px rgba(106, 13, 173, 0.25);
            }
    
            /* âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
            @media (max-width: 480px) {
                .modal {
                    padding: 12px;
                    max-width: 90%;
                }
    
                h2 {
                    font-size: 1.2rem;
                }
    
                .btn {
                    font-size: 0.75rem;
                    padding: 0.5rem;
                }
            }
        </style>
    </head>
<body>
    {% include 'navbar.html' %}
    
    <div class="modal">
        <h2>â• Add New Project</h2>

        <form method="POST" enctype="multipart/form-data" id="createProjectForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label>Project Type</label>
                {{ form.category }}
            </div>

            <div class="form-group">
                <label>Project Logo</label>
                <div class="file-upload">
                    <input type="file" id="id_logo" name="logo" class="file-input">
                    <span>ğŸ“ Click to upload logo</span>
                </div>
                <div id="logo-preview" class="file-preview"></div>
            </div>

            <div class="form-group">
                <label>Project Name</label>
                {{ form.name }}
            </div>

            <div class="form-group">
                <label>Description</label>
                {{ form.description }}
            </div>

            <div class="form-group">
                <label>Attachments</label>
                <div class="file-upload">
                    <input type="file" id="id_attachments" name="attachments" multiple>
                    <span>ğŸ“ Click to add attachments</span>
                </div>
                <div id="attachments-preview" class="file-preview"></div>
            </div>

            <div class="date-container">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="id_start_date" name="start_date" required>
                </div>
                
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="id_end_date" name="end_date" required>
                </div>
            </div>

            <div class="form-group">
                <label>Project Color</label>
                <select id="projectColor" name="project_color" class="color-select">
                    <option value="purple" style="background: #6a0dad; color: white;">Purple</option>
                    <option value="red" style="background: #ff4757; color: white;">Red</option>
                    <option value="blue" style="background: #1e90ff; color: white;">Blue</option>
                    <option value="green" style="background: #2ed573; color: white;">Green</option>
                    <option value="orange" style="background: #ffa502; color: white;">Orange</option>
                    <option value="pink" style="background: #ff6b81; color: white;">Pink</option>
                </select>
            </div>

            <div class="buttons">
                <button type="button" class="btn cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn add">Create Project</button>
            </div>
        </form>
    </div>

    <script>
        // âœ… Ensure closeModal() is globally available
        function closeModal() {
            window.location.href = "{% url 'projects_list' %}";
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            initializeColorSelection();
            initializeDateRestrictions();
            initializeFileUploadListeners();
            initializeFormSubmission();
        });
    
        // âœ… Update color selection dynamically
        function initializeColorSelection() {
            let colorSelect = document.getElementById("projectColor");
            let colorText = document.getElementById("colorValue");
    
            if (colorSelect && colorText) {
                colorSelect.addEventListener("change", function() {
                    let selectedColorName = colorSelect.options[colorSelect.selectedIndex].text;
                    colorText.textContent = selectedColorName;
                });
            }
        }
    
        // âœ… Restrict date selection to prevent past dates
        function initializeDateRestrictions() {
            let today = new Date().toISOString().split("T")[0];
    
            let startDateInput = document.getElementById('id_start_date');
            let endDateInput = document.getElementById('id_end_date');
    
            if (startDateInput) startDateInput.setAttribute("min", today);
            if (endDateInput) endDateInput.setAttribute("min", today);
        }
    
        // âœ… Update file preview dynamically
        function displayFileName(input, previewId) {
            let previewContainer = document.getElementById(previewId);
            if (!previewContainer) return;
    
            previewContainer.innerHTML = "";
    
            if (input.files.length > 0) {
                previewContainer.style.display = "block";
    
                Array.from(input.files).forEach(file => {
                    let fileItem = document.createElement("div");
                    fileItem.style.display = "flex";
                    fileItem.style.alignItems = "center";
                    fileItem.style.marginTop = "5px";
    
                    let fileIcon = document.createElement("span");
                    fileIcon.innerHTML = "ğŸ“„";
                    fileIcon.style.marginRight = "8px";
    
                    let fileName = document.createElement("span");
                    fileName.textContent = file.name;
                    
                    fileItem.appendChild(fileIcon);
                    fileItem.appendChild(fileName);
                    previewContainer.appendChild(fileItem);
                });
            } else {
                previewContainer.style.display = "none";
            }
        }
    
        // âœ… Add listeners to update file previews
        function initializeFileUploadListeners() {
            let logoInput = document.getElementById('id_logo');
            let attachmentsInput = document.getElementById('id_attachments');
    
            if (logoInput) {
                logoInput.addEventListener("change", function() {
                    displayFileName(this, 'logo-preview');
                });
            }
    
            if (attachmentsInput) {
                attachmentsInput.addEventListener("change", function() {
                    displayFileName(this, 'attachments-preview');
                });
            }
        }
    
        // âœ… Submit form using Fetch and handle success with redirect
        function initializeFormSubmission() {
            let form = document.getElementById("createProjectForm");
            if (!form) return;
    
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                let formData = new FormData(this);
    
                fetch("{% url 'create_project' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Server Response:", data); // âœ… Log response for debugging
    
                    if (data.success && data.redirect_url) {
                        console.log("Redirecting to:", data.redirect_url);
                        window.location.href = data.redirect_url;  // âœ… Redirect after successful creation
                    } else {
                        showErrorModal("âŒ Error saving project. Please check your inputs.");
                    }
                })
                .catch(error => {
                    console.error("âŒ Request Error:", error);
                    showErrorModal(`âŒ An error occurred while connecting to the server. Please try again. ${error.message}`);
                });
            });
        }
    
        // âœ… Show error modal for failed requests
        function showErrorModal(errorMessage) {
            let errorModal = document.createElement("div");
            errorModal.classList.add("error-modal-overlay");
            errorModal.innerHTML = `
                <div class="error-modal">
                    <h2>âš ï¸ Error</h2>
                    <p>${errorMessage}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="error-btn">OK</button>
                </div>
            `;
            document.body.appendChild(errorModal);
            errorModal.style.display = "flex";
        }
    </script>
</body>
</html>